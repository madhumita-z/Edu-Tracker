const express = require('express');
const cors = require('cors');
const dotenv = require('dotenv');
const path = require('path');

// Load environment variables
dotenv.config();

// Create Express app
const app = express();
const PORT = process.env.PORT || 5000;

// ========== MIDDLEWARE ==========
app.use(cors());
app.use(express.json());
app.use(express.urlencoded({ extended: true }));

// ========== DATABASE ==========
const db = require('./config/database');

// Make db available to routes
app.locals.db = db;

// ========== API ROUTES ==========
// Test route
app.get('/api/test', (req, res) => {
    res.json({ 
        message: 'âœ… Backend is working!',
        timestamp: new Date().toISOString(),
        environment: process.env.NODE_ENV || 'development'
    });
});

// Auth routes
app.post('/api/login', (req, res) => {
    const { email, password, user_type } = req.body;
    
    // Demo credentials
    if (email === 'student@clg.edu.in' && password === 'password123' && user_type === 'student') {
        res.json({
            success: true,
            token: 'demo_student_token',
            user: {
                id: 1,
                email: 'student@clg.edu.in',
                name: 'Alex Johnson',
                user_type: 'student',
                branch: 'Computer Science'
            }
        });
    } else if (email === 'faculty@clg.edu.in' && password === 'password123' && user_type === 'faculty') {
        res.json({
            success: true,
            token: 'demo_faculty_token',
            user: {
                id: 2,
                email: 'faculty@clg.edu.in',
                name: 'Dr. Sarah Williams',
                user_type: 'faculty',
                branch: 'Computer Science'
            }
        });
    } else {
        res.status(401).json({ error: 'Invalid credentials' });
    }
});

// Student dashboard
app.get('/api/student/dashboard', (req, res) => {
    res.json({
        success: true,
        dashboard: {
            attendance_percentage: 87,
            gpa: 3.8,
            applications_count: 3,
            upcoming_deadlines: 2
        }
    });
});

// Faculty dashboard
app.get('/api/faculty/dashboard', (req, res) => {
    res.json({
        success: true,
        dashboard: {
            total_students: 42,
            avg_attendance: 85,
            placement_ready: 28,
            pending_attendance: 3
        }
    });
});

// QR Code generation
app.post('/api/attendance/qr/generate', (req, res) => {
    res.json({
        success: true,
        qrCode: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNk+A8AAQUBAScY42YAAAAASUVORK5CYII=',
        sessionId: 'QR' + Date.now(),
        expiresIn: 15
    });
});

// ========== STATIC FILES ==========
app.use(express.static(path.join(__dirname, '../frontend')));

// Serve frontend for all other routes
app.get('*', (req, res) => {
    res.sendFile(path.join(__dirname, '../frontend', 'index.html'));
});

// ========== ERROR HANDLER ==========
app.use((err, req, res, next) => {
    console.error(err.stack);
    res.status(500).json({ error: 'Something went wrong!' });
});

// ========== START SERVER ==========
app.listen(PORT, '0.0.0.0', () => {
    console.log(`âœ… Server running on port ${PORT}`);
    console.log(`ğŸŒ Environment: ${process.env.NODE_ENV || 'development'}`);
    console.log(`ğŸ“Š Test API: http://localhost:${PORT}/api/test`);
});